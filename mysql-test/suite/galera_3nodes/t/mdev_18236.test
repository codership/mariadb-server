#
# MDEV-18236 Galera node should raise an error when another node has
#            the same UUID
#
# This test runs four scenarios in which one of the nodes tries
# to join the cluster with a member UUID which already exists
# in the cluster. This is done by restarting node_2 with gvwstate.dat
# which is copied from either node_1 or node_3.
#

--source include/galera_cluster.inc
--source include/have_innodb.inc
--source include/big_test.inc

--let $galera_connection_name = node_3
--let $galera_server_number = 3
--source include/galera_connect.inc

# Save original auto_increment_offset values.
--let $node_1=node_1
--let $node_2=node_2
--let $node_3=node_3
--source ../galera/include/auto_increment_offset_save.inc


#
# Case 1
#
# Shutdown node_2, copy gvwstate.dat from node_1. Restarting node_2
# makes it connect first to node_1 which has the same UUID.
#

# Copy file from running cluster, otherwise the node_2 may
# be able to rebootstrap the singleton cluster before the first connection
# is established.
--echo Copy gvwstate from node_1
--copy_file $MYSQLTEST_VARDIR/mysqld.1/data/gvwstate.dat $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat

--echo Shutdown node_2
--connection node_2
--source include/shutdown_mysqld.inc

--echo Move gvwstate under node_2 datadir
--move_file $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat $MYSQLTEST_VARDIR/mysqld.2/data/gvwstate.dat

# Write error log to separate file. The process my abort in Galera/gcs
# code, which will cause ASAN memleak warnings.
--echo Start node_2, should fail
--error 1
--exec $MYSQLD --defaults-group-suffix=.2 --defaults-file=$MYSQLTEST_VARDIR/my.cnf --innodb --log-error=$MYSQLTEST_VARDIR/tmp/mdev_18236_1.err

--echo Start node_2, should succeed
--source include/start_mysqld.inc

#
# Case 2
#
# Kill node_2, copy gvwstate.dat from node_1. Restarting node_2
# makes it connect first to node_1 which has the same UUID.
#

--echo Copy gvwstate from node_1
--copy_file $MYSQLTEST_VARDIR/mysqld.1/data/gvwstate.dat $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat

--echo Kill node_2
--connection node_2
--source include/kill_mysqld.inc

--echo Move gvwstate under node_2 datadir
--move_file $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat $MYSQLTEST_VARDIR/mysqld.2/data/gvwstate.dat

# Write error log to separate file. The process my abort in Galera/gcs
# code, which will cause ASAN memleak warnings.
--echo Start node_2, should fail
--error 1
--exec $MYSQLD --defaults-group-suffix=.2 --defaults-file=$MYSQLTEST_VARDIR/my.cnf --innodb --log-error=$MYSQLTEST_VARDIR/tmp/mdev_18236_2.err

--echo Start node_2, should succeed
--source include/start_mysqld.inc

#
# Case 3
#
# Shutdown node_2, copy gvwstate.dat from node_3. Restarting node_2
# makes it connect first to node_1 which should have live connection
# from node_3 and so should reject node_2.
#

--echo Copy gvwstate from node_3
--copy_file $MYSQLTEST_VARDIR/mysqld.3/data/gvwstate.dat $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat

--echo Shutdown node_2
--source include/shutdown_mysqld.inc

--echo Move gvwstate under node_2 datadir
--move_file $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat $MYSQLTEST_VARDIR/mysqld.2/data/gvwstate.dat

--echo Start node_2, should fail
--error 1
--exec $MYSQLD --defaults-group-suffix=.2 --defaults-file=$MYSQLTEST_VARDIR/my.cnf --innodb --log-error=$MYSQLTEST_VARDIR/tmp/mdev_18236_3.err

--echo Start node_2, should succeed
--source include/start_mysqld.inc

#
# Case 4
#
# Kill node_2, copy gvwstate.dat from node_3. Restarting node_2
# makes it connect first to node_1 which should have live connection
# from node_3 and so should reject node_2.
#

--echo Copy gvwstate from node_3
--copy_file $MYSQLTEST_VARDIR/mysqld.3/data/gvwstate.dat $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat

--echo Kill node_2
--source include/kill_mysqld.inc

--echo Move gvwstate under node_2 datadir
--move_file $MYSQLTEST_VARDIR/tmp/mdev_18236_gvwstate.dat $MYSQLTEST_VARDIR/mysqld.2/data/gvwstate.dat

--echo Start node_2, should fail
--error 1
--exec $MYSQLD --defaults-group-suffix=.2 --defaults-file=$MYSQLTEST_VARDIR/my.cnf --innodb --log-error=$MYSQLTEST_VARDIR/tmp/mdev_18236_4.err

--echo Start node_2, should succeed
--source include/start_mysqld.inc

--source ../galera/include/auto_increment_offset_restore.inc
