connection node_2;
connection node_1;
connect node_3, 127.0.0.1, root, , test, $NODE_MYPORT_3;
connect node_2a, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection node_2a;
SET SESSION wsrep_sync_wait = 0;
CREATE SEQUENCE s1 NOCACHE ENGINE=InnoDB;
CREATE SEQUENCE s2 NOCACHE ENGINE=InnoDB;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) ENGINE=InnoDB;
connection node_1;
SELECT NEXTVAL(s1);
NEXTVAL(s1)
1
connection node_1;
SELECT next_not_cached_value FROM s1;
next_not_cached_value
2
connection node_2;
SELECT next_not_cached_value FROM s1;
next_not_cached_value
2
connection node_3;
SELECT next_not_cached_value FROM s1;
next_not_cached_value
2
connection node_1;
connection node_2;
connection node_1;
SELECT NEXTVAL(s1);
NEXTVAL(s1)
2
connection node_2;
SELECT NEXTVAL(s1);
NEXTVAL(s1)
3
connection node_1;
BEGIN;
INSERT INTO t1 SELECT NEXTVAL(s1);
INSERT INTO t1 SELECT NEXTVAL(s1);
INSERT INTO t1 SELECT NEXTVAL(s1);
ROLLBACK;
connection node_2;
BEGIN;
INSERT INTO t1 SELECT NEXTVAL(s1);
INSERT INTO t1 SELECT NEXTVAL(s1);
INSERT INTO t1 SELECT NEXTVAL(s1);
COMMIT;
connection node_2;
SET GLOBAL DEBUG_DBUG = 'd,sync.wsrep_apply_cb';
BEGIN;
SELECT NEXTVAL(s2);
NEXTVAL(s2)
1
INSERT INTO t1 VALUES(0);
INSERT INTO t1 VALUES(NEXTVAL(s2));
connection node_1;
BEGIN;
SELECT NEXTVAL(s1);
NEXTVAL(s1)
10
connection node_2;
SET SESSION debug_sync = "now WAIT_FOR sync.wsrep_apply_cb_reached";
SELECT NEXTVAL(s1);;
connection node_2a;
SET DEBUG_SYNC='now SIGNAL signal.wsrep_apply_cb';
SET GLOBAL DEBUG_DBUG = '';
connection node_2;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
connection node_1;
COMMIT;
connection node_3;
# restart
SELECT * FROM t1;
f1
7
8
9
SELECT next_not_cached_value FROM s1;
next_not_cached_value
11
SELECT next_not_cached_value FROM s2;
next_not_cached_value
3
connection node_1;
SELECT * FROM t1;
f1
7
8
9
SELECT next_not_cached_value FROM s1;
next_not_cached_value
11
SELECT next_not_cached_value FROM s2;
next_not_cached_value
3
connection node_2;
SELECT * FROM t1;
f1
7
8
9
SELECT next_not_cached_value FROM s1;
next_not_cached_value
11
SELECT next_not_cached_value FROM s2;
next_not_cached_value
3
connection node_2;
SET DEBUG_SYNC='RESET';
DROP TABLE t1,s1,s2;
