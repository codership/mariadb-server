--let $galera_shards= 2
--let $galera_shard_size= 2

--source include/galera_spider_init.inc

# setup tables
# -------------------
--source include/create_test_tables.inc


# disable Spider's internal XA
# ------------------
--connection spider_1
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET LOCAL spider_internal_xa=0;
--connection spider_2
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET LOCAL spider_internal_xa=0;


# BF abort happens when 'xa prepare' is issued at shard 1
# ----------------------------
--connection spider_1
INSERT INTO hashpart values (1,'0'), (2,'0');
XA START 'test';
UPDATE hashpart SET val='1' WHERE id=1;
UPDATE hashpart SET val='1' WHERE id=2;
XA END 'test';

--connection spider_2
UPDATE hashpart set val='2' where id=1;  # trigger BF abort on shard 1

--connection spider_1
--error 1180
XA PREPARE 'test';
# spider rollbacks the transaction on prepare error
--error 1397 # XAER_NOTA
XA ROLLBACK 'test';
--echo # expect entry for shard 1
SELECT scheme, socket, host, port FROM mysql.spider_xa_member;
--echo # expect one entry for the XA
SELECT status FROM mysql.spider_xa;
SELECT count(*) `expect 0` FROM mysql.spider_xa_failed_log;

TRUNCATE mysql.spider_xa_member;
TRUNCATE mysql.spider_xa;
TRUNCATE hashpart;


# BF abort happens when 'xa prepare' is issued at shard 2
# ----------------------------

--connection spider_1
INSERT INTO hashpart values (1,'0'), (2,'0');
XA START 'test';
UPDATE hashpart SET val='1' WHERE id=1;
UPDATE hashpart SET val='1' WHERE id=2;
XA END 'test';

--connection spider_2
UPDATE hashpart set val='2' where id=2;  # trigger BF abort on shard 2

--connection spider_1
# TODO: what error should be returned here?
--error 1180
XA PREPARE 'test';
--error 1397 # XAER_NOTA
XA ROLLBACK 'test';
--echo # expect two entries, one for each shard
SELECT scheme, socket, host, port FROM mysql.spider_xa_member;
--echo # expect one entry for the XA
SELECT status FROM mysql.spider_xa;
SELECT count(*) `expect 0` FROM mysql.spider_xa_failed_log;

TRUNCATE mysql.spider_xa_member;
TRUNCATE mysql.spider_xa;
TRUNCATE hashpart;


# cleanup tables
# ----------------------
--source include/drop_test_tables.inc

--source include/galera_spider_end.inc
