--source include/galera_cluster.inc

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1

--connection node_1
create table t1(a int not null primary key, b int) engine=innodb;
insert into t1 values (1,1),(2,2),(3,3),(4,4);

--connection node_1
# Pause delete before inside trx_t::commit() before trx_t::commit_cleanup()
SET SESSION debug_dbug = '+d,sync.wsrep_trx_commit';
--send delete from t1 where a = 7;

# Wait until delete reaches sync point
--connection node_1a
SET SESSION DEBUG_SYNC = 'now WAIT_FOR sync.wsrep_trx_commit_reached';

--connection node_1b
#
# Send conflicting operation to same table we will find MDL-conflict
# but as victim is already committing there will be no BF abort.
--send OPTIMIZE TABLE t1;

--connection node_1a
# Release delete to continue
SET SESSION DEBUG_SYNC = 'now SIGNAL signal.wsrep_after_run_commit_hooks';
# Release optimize table
SET SESSION DEBUG_SYNC = 'now SIGNAL signal.wsrep_before_wsrep_thd_abort';
SET SESSION DEBUG_SYNC = 'RESET';
SET GLOBAL debug_dbug = '';

--connection node_1
--error 0,ER_LOCK_DEADLOCK
--reap

--connection node_1b
--reap

drop table t1;

