--source include/galera_cluster.inc
--source include/have_innodb.inc
--source include/have_debug_sync.inc

SET @@GLOBAL.debug="+d,wsrep_disable_fix";

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_apply_cb";

--connection node_1
CREATE TABLE t1(c1 INT PRIMARY KEY, c2 INT) ENGINE=INNODB;
INSERT INTO t1 VALUES (1,0);

BEGIN;
--error 1062
INSERT INTO t1 VALUES (2,4),(1,1);
--error 1305
ROLLBACK TO SAVEPOINT A;

--connection node_2
UPDATE t1 SET c2=2 WHERE c1=1;

--connection node_1a
SET DEBUG_SYNC = "now WAIT_FOR sync.wsrep_apply_cb_reached";

--connection node_1
--send COMMIT
--sleep 30

--connection node_1a
SET DEBUG_SYNC = "now SIGNAL signal.wsrep_apply_cb";

--connection node_1
--reap
# Cleanup
DROP TABLE t1;

--source include/galera_end.inc
--echo # End of test
