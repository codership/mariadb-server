--source include/galera_cluster.inc
--source include/have_innodb.inc


--echo =====================================
--echo Test phase 1
--echo =====================================


CREATE TABLE parent(a_id INT, PRIMARY KEY(a_id));
CREATE TABLE child (b_id INT, a_id int, PRIMARY KEY(b_id), FOREIGN KEY (a_id) REFERENCES parent(a_id) ON DELETE CASCADE);

INSERT INTO parent VALUES (1),(2),(3),(4),(5);
INSERT INTO child VALUES (11,4),(22,2),(33,5),(44,1),(55,3);  

SELECT * FROM parent;
SELECT * FROM child;

--send DELETE FROM parent;

--connection node_2
--error 0,ER_LOCK_DEADLOCK,ER_KEY_NOT_FOUND
DELETE FROM child WHERE a_id=3;

--connection node_1 
--error 0,ER_LOCK_DEADLOCK
--reap

DROP TABLE child;
DROP TABLE parent;


--echo =====================================
--echo Test phase 2
--echo =====================================


--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1

CREATE TABLE parent(a_id INT, PRIMARY KEY(a_id));
CREATE TABLE child (b_id INT, a_id int, PRIMARY KEY(b_id), FOREIGN KEY (a_id) REFERENCES parent(a_id) ON DELETE CASCADE);

INSERT INTO parent VALUES (1),(2);
INSERT INTO child VALUES (11,1);

SELECT * FROM parent;
SELECT * FROM child;

--connection node_1a
--send TRUNCATE child;

--connection node_1b
--error 0,ER_DUP_ENTRY
INSERT INTO child VALUES (11,1);

--connection node_1a
--reap

DROP TABLE child;
DROP TABLE parent;


--echo =====================================
--echo Test phase 3
--echo =====================================


CREATE TABLE parent(a_id INT, PRIMARY KEY(a_id));
CREATE TABLE child (b_id INT, a_id int, PRIMARY KEY(b_id), FOREIGN KEY (a_id) REFERENCES parent(a_id) ON DELETE CASCADE);

--connection node_2
SET GLOBAL wsrep_slave_threads=2;

INSERT INTO parent VALUES (1),(2);
INSERT INTO child VALUES (11,1);

SELECT * FROM parent;
SELECT * FROM child;

--connection node_1a
--send TRUNCATE child;

--connection node_1b
--error 0,ER_DUP_ENTRY
INSERT INTO child VALUES (11,1);

--connection node_2
SET GLOBAL wsrep_slave_threads=default;

--connection node_1a
--reap

DROP TABLE child;
DROP TABLE parent;


--echo =====================================
--echo Test phase 4
--echo =====================================


--connect node_1c, 127.0.0.1, root, , test, $NODE_MYPORT_1

CREATE TABLE parent(a_id INT, PRIMARY KEY(a_id));
CREATE TABLE child (b_id INT, a_id int, PRIMARY KEY(b_id), FOREIGN KEY (a_id) REFERENCES parent(a_id) ON DELETE CASCADE);

--connection node_2
SET GLOBAL wsrep_slave_threads=2;

INSERT INTO parent VALUES (1),(2);
INSERT INTO child VALUES (11,1);

SELECT * FROM parent;
SELECT * FROM child;

--connection node_1c
--send DELETE FROM parent

--connection node_1a
--send TRUNCATE child;

--connection node_1b
--error 0,ER_DUP_ENTRY,1452,1213
INSERT INTO child VALUES (11,1);

--connection node_2
SET GLOBAL wsrep_slave_threads=default;

--connection node_1a
--reap

--connection node_1c
--error 0,1213
--reap

DROP TABLE child;
DROP TABLE parent;


--echo =====================================
--echo Test phase 5
--echo =====================================


CREATE TABLE gparent (a_id INT, PRIMARY KEY(a_id));
CREATE TABLE parent (b_id INT, a_id INT, PRIMARY KEY(b_id), FOREIGN KEY (a_id) REFERENCES gparent(a_id) ON DELETE CASCADE);
CREATE TABLE child (c_id INT, b_id INT, PRIMARY KEY(c_id), FOREIGN KEY (b_id) REFERENCES parent(b_id) ON DELETE CASCADE);

INSERT INTO gparent VALUES (1),(2),(3);
INSERT INTO parent VALUES (11,1),(22,2),(33,3);
INSERT INTO child VALUES (111,11),(222,22),(333,33);

SELECT * FROM gparent;
SELECT * FROM parent;
SELECT * FROM child;

DELETE FROM gparent WHERE a_id = 2;

--connection node_2
SELECT * FROM gparent;
SELECT * FROM parent;
SELECT * FROM child;

--connection node_1
SELECT * FROM gparent;
SELECT * FROM parent;
SELECT * FROM child;

DROP TABLE child;
DROP TABLE parent;
DROP TABLE gparent;


--echo =====================================
--echo Test phase 6
--echo =====================================


CREATE TABLE gparent (a_id INT, PRIMARY KEY(a_id));
CREATE TABLE parent (b_id INT, a_id INT, PRIMARY KEY(b_id), FOREIGN KEY (a_id) REFERENCES gparent(a_id) ON DELETE CASCADE);
CREATE TABLE child (c_id INT, b_id INT, PRIMARY KEY(c_id), FOREIGN KEY (b_id) REFERENCES parent(b_id) ON DELETE CASCADE);

INSERT INTO gparent VALUES (1),(2),(3);
INSERT INTO parent VALUES (11,1),(22,2),(33,3);
INSERT INTO child VALUES (111,11),(222,22),(333,33);

SELECT * FROM gparent;
SELECT * FROM parent;
SELECT * FROM child;

--send DELETE FROM gparent WHERE a_id = 2;

--connection node_2
--error 0,ER_LOCK_DEADLOCK
DELETE FROM child;

--connection node_1
--error 0,ER_LOCK_DEADLOCK
--reap
SELECT * FROM gparent;
SELECT * FROM parent;
SELECT * FROM child;

--connection node_2
SELECT * FROM gparent;
SELECT * FROM parent;
SELECT * FROM child;

DROP TABLE child;
DROP TABLE parent;
DROP TABLE gparent;