#
# Check binlog contents when using Galera and SEQUENCE
#

--source include/galera_cluster.inc

# For include/show_binlog_events.inc
--let $MASTER_MYPORT=$NODE_MYPORT_1
--let $binlog_file=LAST

--echo #
--echo # Autocommit statements
--echo #
--connection node_1
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;

--connection node_1
SELECT NEXTVAL(SEQ);

--connection node_2
SELECT NEXTVAL(SEQ);

--connection node_1
--let $binlog_limit=5,20
--source include/show_binlog_events.inc

--connection node_2
--let $binlog_limit=4,20
--source include/show_binlog_events.inc


--echo #
--echo # INSERT NEXTVAL
--echo #
--connection node_1
INSERT INTO t1 SELECT NEXTVAL(SEQ);
SELECT * FROM t1;

--connection node_2
INSERT INTO t1 VALUES (NEXTVAL(SEQ));
SELECT * FROM t1;

--connection node_1
--let $binlog_limit=15,20
--source include/show_binlog_events.inc

--connection node_2
--let $binlog_limit=14,20
--source include/show_binlog_events.inc

--connection node_1
DROP TABLE t1,SEQ;


--echo #
--echo #  NEXTVAL in transaction
--echo #
--connection node_1
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;

START TRANSACTION;
SELECT NEXTVAL(SEQ);
COMMIT;

--connection node_2
START TRANSACTION;
SELECT NEXTVAL(SEQ);
ROLLBACK;

--connection node_1
--let $binlog_limit=33,20
--source include/show_binlog_events.inc

--connection node_2
--let $binlog_limit=32,20
--source include/show_binlog_events.inc

--connection node_1
DROP TABLE SEQ;


--echo #
--echo # INSERT NEXTVAL in transaction
--echo #
--connection node_1
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);

START TRANSACTION;
INSERT INTO t1 VALUES (100);
INSERT INTO t1 SELECT NEXTVAL(SEQ);
INSERT INTO t1 VALUES (101);
COMMIT;
SELECT * FROM t1;
SELECT LASTVAL(SEQ);

--connection node_2
START TRANSACTION;
INSERT INTO t1 VALUES (200);
INSERT INTO t1 SELECT NEXTVAL(SEQ);
INSERT INTO t1 VALUES (201);
ROLLBACK;
SELECT * FROM t1;
SELECT LASTVAL(SEQ);


--connection node_1
--let $binlog_limit=49,20
--source include/show_binlog_events.inc

--connection node_2
--let $binlog_limit=48,20
--source include/show_binlog_events.inc

--connection node_1
DROP TABLE t1, SEQ;
