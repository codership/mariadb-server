--source include/galera_cluster.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc
--source include/galera_have_debug_sync.inc

CREATE TABLE parent (
	id INT PRIMARY KEY,
	j INT
) ENGINE=InnoDB;

CREATE TABLE child (
	id INT PRIMARY KEY AUTO_INCREMENT,
	parent_id INT,
	KEY (parent_id),
	CONSTRAINT FOREIGN KEY (parent_id) REFERENCES parent(id)
) ENGINE=InnoDB;

--connection node_1
INSERT INTO parent VALUES (1,1);

--connection node_2
--let $wait_condition = SELECT COUNT(*) = 1 from parent;
--source include/wait_condition.inc
SET GLOBAL debug_dbug ='+d,wsrep_force_FK_check_fail';
SET GLOBAL wsrep_slave_FK_checks = ON;
SET GLOBAL wsrep_applier_FK_failure_retries = 5;

#  make sure sync wait happens in this connection
SET wsrep_sync_wait = 15;

--connection node_1
INSERT INTO child VALUES (1,1);

--connection node_2
# Ensure that write succeeded in both nodes
SELECT * from child;

--let $assert_select = final FK constraint check failed
--let $assert_count = 0
--let $assert_text = warning for FK constraint failure exists
--let $assert_only_after = CURRENT_TEST
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--source include/assert_grep.inc

# now setting retries low so that FK failure happens
SET GLOBAL wsrep_applier_FK_failure_retries = 1;

--connection node_1
INSERT INTO child VALUES (2,1);

SELECT * from child;

--connection node_2
# must be careful to disable wsrep_force_FK_check_fail variable
# as it could happen concurrently with applier execution
# therefore making a non-related select which is waiting for sync wait
#
select * from parent;
SET GLOBAL debug_dbug = NULL;

--connection node_2
SET GLOBAL wsrep_slave_FK_checks = DEFAULT;
SET GLOBAL wsrep_applier_FK_failure_retries = DEFAULT;

--let $assert_select = final FK constraint check failed
--let $assert_count = 1
--let $assert_text = warning for FK constraint failure missing
--let $assert_only_after = CURRENT_TEST
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--source include/assert_grep.inc


CALL mtr.add_suppression("final FK constraint check failed for.*");

--connection node_1
DROP TABLE child;
DROP TABLE parent;
