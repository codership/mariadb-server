#
# Test for BF aborting mariabackup execution
#

--source include/galera_cluster.inc
--source include/have_innodb.inc
--source include/have_debug_sync.inc

CREATE TABLE t1 (f1 INTEGER PRIMARY KEY, f2 VARCHAR(10)) ENGINE=InnoDB;
set global wsrep_sync_wait=0;

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1

--connection node_1a
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_apply_toi";

--connection node_2
DROP TABLE t1;

--connection node_1a
SET SESSION DEBUG_SYNC = "now WAIT_FOR sync.wsrep_apply_toi_reached";
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "";
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_after_mdl_block_ddl_signal";

--connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connection node_1b
--let $targetdir=$MYSQLTEST_VARDIR/tmp/backup
let outfile=$MYSQLTEST_VARDIR/tmp/backup.out;
SET @@global.wsrep_mode=BF_ABORT_MARIABACKUP;
--exec $XTRABACKUP --defaults-file=$MYSQLTEST_VARDIR/my.cnf --backup  --target-dir=$targetdir  2>&1 >$outfile

--connection node_1a
SET SESSION DEBUG_SYNC = "now SIGNAL signal.wsrep_apply_toi";
#SET SESSION DEBUG_SYNC = "";
SET SESSION DEBUG_SYNC = "RESET";
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "";

--sleep 10

--connection node_1a
SET SESSION DEBUG_SYNC = "now SIGNAL wsrep_after_mdl_block_ddl_wait_continue";
SET @@debug_dbug = "";
SET SESSION DEBUG_SYNC = "RESET";
SET GLOBAL DEBUG_DBUG = "";


--connection node_1b
--error 0,2013, ER_CONNECTION_KILLED
--reap

--connection node_1
set @@global.wsrep_mode=default;
set @@global.wsrep_sync_wait=default;
SET GLOBAL DEBUG_DBUG = "";


