#
# Test for BF aborting mariabackup execution
#

--source include/galera_cluster.inc
--source include/have_innodb.inc
--source include/have_debug_sync.inc

set global wsrep_sync_wait=0;

CREATE TABLE t1 (f1 INTEGER PRIMARY KEY, f2 VARCHAR(10)) ENGINE=InnoDB;

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1

--connection node_1a
#SET SESSION DEBUG_SYNC = "now WAIT_FOR sync.wsrep_after_mdl_block_ddl"
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_apply_toi";

--connection node_2
#CREATE TABLE t2 (f1 INTEGER PRIMARY KEY) ENGINE=InnoDB;
DROP TABLE t1;

--connection node_1a
SET SESSION DEBUG_SYNC = "now WAIT_FOR sync.wsrep_apply_toi_reached";
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "";
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_after_mdl_block_ddl";

--connection node_2
CREATE TABLE t2 (f1 INTEGER PRIMARY KEY) ENGINE=InnoDB;

--connection node_1
--sleep 30
--let $targetdir=$MYSQLTEST_VARDIR/tmp/backup
set wsrep_sync_wait=0;

--exec $XTRABACKUP --defaults-file=$MYSQLTEST_VARDIR/my.cnf --backup  --target-dir=$targetdir


--connection node_1a
show processlist;

DROP TABLE t1;
drop table t2;