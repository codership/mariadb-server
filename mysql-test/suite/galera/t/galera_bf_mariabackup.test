#
# Test for BF aborting mariabackup execution
#

--source include/galera_cluster.inc
--source include/have_innodb.inc
--source include/have_debug_sync.inc

#set global wsrep_sync_wait=0;

CREATE TABLE t1 (f1 INTEGER PRIMARY KEY, f2 VARCHAR(10)) ENGINE=InnoDB;

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1

--connection node_1a
#SET SESSION DEBUG_SYNC = "now WAIT_FOR sync.wsrep_after_mdl_block_ddl"
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_apply_toi";

--connection node_2
#CREATE TABLE t2 (f1 INTEGER PRIMARY KEY) ENGINE=InnoDB;
DROP TABLE t1;

--connection node_1a
SET SESSION DEBUG_SYNC = "now WAIT_FOR sync.wsrep_apply_toi_reached";
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "";
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_after_mdl_block_ddl_wait";

--connection node_2
CREATE TABLE t2 (f1 INTEGER PRIMARY KEY) ENGINE=InnoDB;

--connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connection node_1b
#--let $targetdir=$MYSQLTEST_VARDIR/tmp/backup
set wsrep_sync_wait=0;
#let outfile=$MYSQLTEST_VARDIR/tmp/backup.out;
SET @@global.wsrep_mode=BF_ABORT_MARIABACKUP;
#--exec $XTRABACKUP --defaults-file=$MYSQLTEST_VARDIR/my.cnf --backup  --target-dir=$targetdir  2>&1 >$outfile
BACKUP STAGE START;
--send BACKUP STAGE BLOCK_COMMIT;

--connection node_1a
SET SESSION DEBUG_SYNC = "now WAIT_FOR wsrep_after_mdl_block_ddl_wait_reached";
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "";

--connection node_1a
SET SESSION DEBUG_SYNC = "now SIGNAL signal.wsrep_apply_toi";
#SET SESSION DEBUG_SYNC = "";
SET SESSION DEBUG_SYNC = "RESET";
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "";

--sleep 10

--connection node_1a
#SET SESSION DEBUG_SYNC = "now SIGNAL wsrep_after_mdl_block_ddl_wait_continue";
SET @@debug_dbug = "";
SET GLOBAL DEBUG_DBUG = "";


--connection node_1b
--error 0,2013, ER_CONNECTION_KILLED
--reap
#BACKUP STAGE BLOCK_DDL;
#show tables;


--connection node_1
set @@global.wsrep_mode=default;
SET GLOBAL DEBUG_DBUG = "";

--connection node_1a

drop table t2;