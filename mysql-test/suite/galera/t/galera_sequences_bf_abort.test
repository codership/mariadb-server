#
# Test conflicts on SEQUENCEs
#

--source include/galera_cluster.inc
--source include/have_debug_sync.inc

# For include/show_binlog_events.inc
--let $MASTER_MYPORT=$NODE_MYPORT_1
--let $binlog_file=LAST

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1

#
# BF abort autocommit NEXTVAL
#
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;

--connection node_1
SET SESSION wsrep_retry_autocommit=0;
SET DEBUG_SYNC='wsrep_before_fragment_certification SIGNAL before_fragment WAIT_FOR continue';
--send SELECT NEXTVAL(SEQ)

--connection node_1a
SET DEBUG_SYNC='now WAIT_FOR before_fragment';

--connection node_2
SELECT NEXTVAL(SEQ);

--connection node_1
--error ER_LOCK_DEADLOCK
--reap

--connection node_1a
SET DEBUG_SYNC='RESET';

--connection node_1
SELECT next_not_cached_value FROM SEQ;

--let $binlog_limit=3,20
--source include/show_binlog_events.inc

--connection node_2
SELECT next_not_cached_value FROM SEQ;

--let $binlog_limit=2,20
--source include/show_binlog_events.inc

DROP TABLE SEQ;


#
# BF abort autocommit INSERT using NEXTVAL
#
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) Engine=InnoDB;

--connection node_1
SET SESSION wsrep_retry_autocommit=0;
SET DEBUG_SYNC='wsrep_before_fragment_certification SIGNAL before_fragment WAIT_FOR continue';
--send INSERT INTO t1 VALUES (NEXTVAL(SEQ));

--connection node_1a
SET DEBUG_SYNC='now WAIT_FOR before_fragment';

--connection node_2
SELECT NEXTVAL(SEQ);

--connection node_1
--error ER_LOCK_DEADLOCK
--reap

--connection node_1a
SET DEBUG_SYNC='RESET';

--connection node_1
SELECT * FROM t1;
SELECT next_not_cached_value FROM SEQ;

--let $binlog_limit=14,20
--source include/show_binlog_events.inc

--connection node_2
SELECT * FROM t1;
SELECT next_not_cached_value FROM SEQ;

--let $binlog_limit=13,20
--source include/show_binlog_events.inc

DROP TABLE t1,SEQ;


#
# BF abort NEXTVAL in multi-stmt transaction
#
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) Engine=InnoDB;

--connection node_1
SET SESSION wsrep_retry_autocommit=0;
SET DEBUG_SYNC='wsrep_before_fragment_certification SIGNAL before_fragment WAIT_FOR continue';
BEGIN;
INSERT INTO t1 VALUES(0);
--send INSERT INTO t1 VALUES (NEXTVAL(SEQ));

--connection node_1a
SET DEBUG_SYNC='now WAIT_FOR before_fragment';

--connection node_2
SELECT NEXTVAL(SEQ);

--connection node_1
--error ER_LOCK_DEADLOCK
--reap

--connection node_1a
SET DEBUG_SYNC='RESET';

--connection node_1
SELECT * FROM t1;
SELECT next_not_cached_value FROM SEQ;

--let $binlog_limit=25,20
--source include/show_binlog_events.inc

--connection node_2
SELECT * FROM t1;
SELECT next_not_cached_value FROM SEQ;

--let $binlog_limit=24,20
--source include/show_binlog_events.inc

DROP TABLE t1,SEQ;
