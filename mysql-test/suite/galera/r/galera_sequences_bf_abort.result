connection node_2;
connection node_1;
connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1;
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;
connection node_1;
SET SESSION wsrep_retry_autocommit=0;
SET DEBUG_SYNC='wsrep_before_fragment_certification SIGNAL before_fragment WAIT_FOR continue';
SELECT NEXTVAL(SEQ);
connection node_1a;
SET DEBUG_SYNC='now WAIT_FOR before_fragment';
connection node_2;
SELECT NEXTVAL(SEQ);
NEXTVAL(SEQ)
1
connection node_1;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
connection node_1a;
SET DEBUG_SYNC='RESET';
connection node_1;
SELECT next_not_cached_value FROM SEQ;
next_not_cached_value
2
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000002	#	Gtid	#	#	BEGIN GTID #-#-#
mysqld-bin.000002	#	Annotate_rows	#	#	SELECT NEXTVAL(SEQ)
mysqld-bin.000002	#	Table_map	#	#	table_id: # (test.SEQ)
mysqld-bin.000002	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
mysqld-bin.000002	#	Xid	#	#	COMMIT /* XID */
connection node_2;
SELECT next_not_cached_value FROM SEQ;
next_not_cached_value
2
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000003	#	Gtid	#	#	BEGIN GTID #-#-#
mysqld-bin.000003	#	Annotate_rows	#	#	SELECT NEXTVAL(SEQ)
mysqld-bin.000003	#	Table_map	#	#	table_id: # (test.SEQ)
mysqld-bin.000003	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
mysqld-bin.000003	#	Query	#	#	COMMIT
DROP TABLE SEQ;
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) Engine=InnoDB;
connection node_1;
SET SESSION wsrep_retry_autocommit=0;
SET DEBUG_SYNC='wsrep_before_fragment_certification SIGNAL before_fragment WAIT_FOR continue';
INSERT INTO t1 VALUES (NEXTVAL(SEQ));;
connection node_1a;
SET DEBUG_SYNC='now WAIT_FOR before_fragment';
connection node_2;
SELECT NEXTVAL(SEQ);
NEXTVAL(SEQ)
1
connection node_1;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
connection node_1a;
SET DEBUG_SYNC='RESET';
connection node_1;
SELECT * FROM t1;
f1
SELECT next_not_cached_value FROM SEQ;
next_not_cached_value
2
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000002	#	Gtid	#	#	BEGIN GTID #-#-#
mysqld-bin.000002	#	Annotate_rows	#	#	SELECT NEXTVAL(SEQ)
mysqld-bin.000002	#	Table_map	#	#	table_id: # (test.SEQ)
mysqld-bin.000002	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
mysqld-bin.000002	#	Xid	#	#	COMMIT /* XID */
connection node_2;
SELECT * FROM t1;
f1
SELECT next_not_cached_value FROM SEQ;
next_not_cached_value
2
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000003	#	Gtid	#	#	BEGIN GTID #-#-#
mysqld-bin.000003	#	Annotate_rows	#	#	SELECT NEXTVAL(SEQ)
mysqld-bin.000003	#	Table_map	#	#	table_id: # (test.SEQ)
mysqld-bin.000003	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
mysqld-bin.000003	#	Query	#	#	COMMIT
DROP TABLE t1,SEQ;
CREATE SEQUENCE SEQ NOCACHE ENGINE=InnoDB;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) Engine=InnoDB;
connection node_1;
SET SESSION wsrep_retry_autocommit=0;
SET DEBUG_SYNC='wsrep_before_fragment_certification SIGNAL before_fragment WAIT_FOR continue';
BEGIN;
INSERT INTO t1 VALUES(0);
INSERT INTO t1 VALUES (NEXTVAL(SEQ));;
connection node_1a;
SET DEBUG_SYNC='now WAIT_FOR before_fragment';
connection node_2;
SELECT NEXTVAL(SEQ);
NEXTVAL(SEQ)
1
connection node_1;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
connection node_1a;
SET DEBUG_SYNC='RESET';
connection node_1;
SELECT * FROM t1;
f1
SELECT next_not_cached_value FROM SEQ;
next_not_cached_value
2
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000002	#	Gtid	#	#	BEGIN GTID #-#-#
mysqld-bin.000002	#	Annotate_rows	#	#	SELECT NEXTVAL(SEQ)
mysqld-bin.000002	#	Table_map	#	#	table_id: # (test.SEQ)
mysqld-bin.000002	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
mysqld-bin.000002	#	Xid	#	#	COMMIT /* XID */
connection node_2;
SELECT * FROM t1;
f1
SELECT next_not_cached_value FROM SEQ;
next_not_cached_value
2
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000003	#	Gtid	#	#	BEGIN GTID #-#-#
mysqld-bin.000003	#	Annotate_rows	#	#	SELECT NEXTVAL(SEQ)
mysqld-bin.000003	#	Table_map	#	#	table_id: # (test.SEQ)
mysqld-bin.000003	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
mysqld-bin.000003	#	Query	#	#	COMMIT
DROP TABLE t1,SEQ;
