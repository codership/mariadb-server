connection node_2;
connection node_1;
connect node_1_ctrl, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1_ctrl;
SET SESSION wsrep_sync_wait=0;
connect node_2_ctrl, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection node_2_ctrl;
SET SESSION wsrep_sync_wait=0;
connection node_1;
CREATE TABLE parent(f1 INT NOT NULL PRIMARY KEY, f2 INT);
CREATE TABLE child(f1 INT NOT NULL PRIMARY KEY, f2 INT, fk INT, FOREIGN KEY(fk) REFERENCES parent(f1));
INSERT INTO parent VALUES (1, 1), (2, 2);
INSERT INTO child VALUES (1, 1, 1), (2, 2, 2);
connection node_1_ctrl;
SET GLOBAL wsrep_provider_options = 'dbug=d,before_replicate_sync';
connection node_1;
INSERT INTO parent VALUES (3, 3);;
connection node_1_ctrl;
SET SESSION wsrep_on = 0;
SET SESSION wsrep_on = 1;
connection node_2_ctrl;
SET GLOBAL wsrep_provider_options = 'dbug=d,before_replicate_sync';
connection node_2;
CREATE INDEX idx ON child (f2, fk);;
connection node_2_ctrl;
SET SESSION wsrep_on = 0;
SET SESSION wsrep_on = 1;
SET GLOBAL wsrep_provider_options = 'dbug=d,after_replicate_sync';
SET GLOBAL wsrep_provider_options = 'signal=before_replicate_sync';
SET SESSION wsrep_on = 0;
SET SESSION wsrep_on = 1;
SET GLOBAL wsrep_provider_options = 'signal=after_replicate_sync';
SET GLOBAL wsrep_provider_options = 'dbug=';
connection node_1_ctrl;
SET GLOBAL wsrep_provider_options = 'signal=before_replicate_sync';
SET GLOBAL wsrep_provider_options = 'dbug=';
connection node_2;
connection node_1;
DROP TABLE child;
DROP TABLE parent;
