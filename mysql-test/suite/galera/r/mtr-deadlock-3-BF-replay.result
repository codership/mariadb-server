connection node_2;
connection node_1;
connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connect node_1c, 127.0.0.1, root, , test, $NODE_MYPORT_1;
CREATE TABLE t (i int primary key, j int);
INSERT INTO t VALUES (1,0),(2,0),(3,0),(5,0);
connection node_1c;
BEGIN;
UPDATE t SET j=33 WHERE i>=3;
connection node_1a;
BEGIN;
UPDATE t SET j=11 WHERE i=1;
connection node_1b;
BEGIN;
UPDATE t SET j=22 WHERE i=2;
connection node_1a;
UPDATE t SET j=11 WHERE i=2;;
connection node_1b;
UPDATE t SET j=22 WHERE i=3;;
connection node_2;
INSERT INTO t VALUES (4,2);
connection node_1c;
UPDATE t SET j=33 WHERE i=1;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
connection node_1b;
COMMIT;
connection node_1a;
COMMIT;
connection node_1c;
COMMIT;
connection node_1a;
SELECT * FROM t;
i	j
1	11
2	11
3	22
4	2
5	0
connection node_1b;
SELECT * FROM t;
i	j
1	11
2	11
3	22
4	2
5	0
connection node_1c;
SELECT * FROM t;
i	j
1	11
2	11
3	22
4	2
5	0
connection node_2;
SELECT * FROM t;
i	j
1	11
2	11
3	22
4	2
5	0
DROP TABLE t;
===============================
Test phase 2
===============================
CREATE TABLE t (i int primary key, j int);
INSERT INTO t VALUES (1,0),(2,0),(4,0),(5,0),(6,0);
connection node_1a;
BEGIN;
UPDATE t SET j=11 WHERE i=1;
connection node_1b;
BEGIN;
UPDATE t SET j=22 WHERE i>=2 AND i<=4;
connection node_1c;
BEGIN;
UPDATE t SET j=33 WHERE i=6;
connection node_1a;
UPDATE t SET j=111 WHERE i=2;;
connection node_1b;
UPDATE t SET j=212 WHERE i=6;;
connection node_2;
INSERT INTO t VALUES (3,2222);
connection node_1c;
UPDATE t SET j=313 WHERE i=1;;
connection node_1a;
COMMIT;
connection node_1b;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
COMMIT;
connection node_1c;
COMMIT;
connection node_1a;
SELECT * FROM t;
i	j
1	313
2	111
3	2222
4	0
5	0
6	33
connection node_1b;
SELECT * FROM t;
i	j
1	313
2	111
3	2222
4	0
5	0
6	33
connection node_1c;
SELECT * FROM t;
i	j
1	313
2	111
3	2222
4	0
5	0
6	33
connection node_2;
SELECT * FROM t;
i	j
1	313
2	111
3	2222
4	0
5	0
6	33
DROP TABLE t;
